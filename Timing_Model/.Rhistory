lines(density(100*inv.logit(thetas_mod2$logit_c1_CQ)), col = drug_cols3['CHQ'],lwd=3)
lines(density(100*inv.logit(thetas_mod2$logit_c1_CQ_PMQ)), col = drug_cols3['CHQ/PMQ'], lwd=3)
legend('topright',col=drug_cols3, legend = c('Artesunate monotherapy','Chloroquine monotherapy','Chloroquine+Primaquine'),lwd=3)
hist(inv.logit(thetas_mod2$logit_EarlyL), xlab = 'Early Relapse',
main='',yaxt='n',ylab='')
par(las=1, mfrow=c(1,1))
# Plot the outcome of the predicted labels
#****************************** Reinfection ******************************
labels2 = extract(mod2_Fit, 'prob_labels')$prob_labels
mean_labels_Reinfection = apply(labels2[,ind_plotting,1,drop=T], 2, mean)
plot(Combined_Time_Data$Time_to_event[ind_plotting], log10(mean_labels_Reinfection),
col = drug_cols3[Combined_Time_Data$numeric_drug[ind_plotting]+1],
pch = as.numeric(Combined_Time_Data$Censored[ind_plotting])+16,
ylab='Probability of ReInfection', yaxt='n',xaxt='n',
xlab='Months from last episode', xlim=c(0,400))
axis(1, at = seq(0, 420, by=60), labels = seq(0, 420, by=60)/30)
axis(2, at = -2:0, labels= 10^(-2:0))
axis(2, at = log10(seq(.1,1,by=.1)), labels = NA)
axis(2, at = log10(seq(.01,.1,by=.01)), labels = NA)
axis(2, at = log10(seq(.001,.01,by=.001)), labels = NA)
legend('bottomright',legend = c('Artesunate','Chloroquine','Chloroquine\nPrimaquine'),
col=c(drug_cols3),pch = rep(1,3), bty='n',lwd=2,lty=NA)
#****************************** Recrudescence ****************************
mean_labels_ReCrud = apply(labels2[,ind_plotting,4,drop=T], 2, mean)
plot(Combined_Time_Data$Time_to_event[ind_plotting], mean_labels_ReCrud,
col = drug_cols3[Combined_Time_Data$numeric_drug[ind_plotting]+1], xaxt='n',
pch = as.numeric(Combined_Time_Data$Censored[ind_plotting])+16,
ylab='ReCrudescence',
xlab='Weeks from last episode', xlim=c(0,60))
axis(1, at = seq(0,54,by=7), labels = seq(0,54,by=7)/7)
#****************************** Relapse ****************************
mean_labels_ReLap1 = apply(labels2[,ind_plotting,2,drop=T], 2, mean)
mean_labels_ReLap2 = apply(labels2[,ind_plotting,3,drop=T], 2, mean)
mean_labels_ReLap = mean_labels_ReLap1 + mean_labels_ReLap2
plot(Combined_Time_Data$Time_to_event[ind_plotting], mean_labels_ReLap,
col = drug_cols3[Combined_Time_Data$numeric_drug[ind_plotting]+1], xaxt='n',
pch = as.numeric(Combined_Time_Data$Censored[ind_plotting])+16,
ylab='log10 Probability of ReLapse',
xlab='Months from last episode')
axis(1, at = seq(0, 420, by= 60), labels = seq(0, 420, by=60)/30)
par(mfrow=c(4,3))
# lambda: reinfection rate
hist(1/thetas_mod2$lambda,freq = FALSE, xlim = c(300,1400), main='',
xlab='Time to reinfection (1/lambda)', ylab = '', yaxt='n', col='grey', breaks=10)
lines(dnorm(x = 1:1400,mean = Prior_params_M2$mu_inv_lambda,
sd = Prior_params_M2$sigma_inv_lambda),
col='red',lwd=3)
# gamma: late relapse rate
hist(1/thetas_mod2$gamma,freq = FALSE, xlim = c(0,160), main='',
xlab='Time to late relapse (1/gamma)', ylab = '', yaxt='n', col='grey', breaks=10)
lines(dnorm(x = 1:1000,mean = Prior_params_M2$mu_inv_gamma,
sd = Prior_params_M2$sigma_inv_gamma),
col='red',lwd=3)
# AS_shape (Weibull shape parameter for AS monotherapy)
hist(thetas_mod2$AS_shape, xlim = c(0,5), freq = F, main='',
xlab= 'AS shape parameter', yaxt='n', ylab='', col='grey', breaks=10)
lines(seq(0,10,by=0.1), dnorm(x = seq(0,10,by=0.1),
mean = Prior_params_M2$mu_AS_shape,
sd = Prior_params_M2$sigma_AS_shape),
col='red',lwd=3)
# AS_scale (Weibill scale parameter for AS monotherapy)
hist(thetas_mod2$AS_scale, xlim = c(15,35), freq = F, main='',
xlab= 'AS scale parameter', yaxt='n', ylab='', col='grey', breaks=10)
lines(seq(0,50,by=1), dnorm(x = seq(0,50,by=1),
mean = Prior_params_M2$mu_AS_scale,
sd = Prior_params_M2$sigma_AS_scale),
col='red',lwd=3)
# CQ_shape (Weibull shape parameter for CQ with or without PMQ)
hist(thetas_mod2$CQ_shape, xlim = c(0,6), freq = F, main='',
xlab= 'CQ shape parameter', yaxt='n', ylab='', col='grey', breaks=10)
lines(seq(0,10,by=0.1), dnorm(x = seq(0,10,by=0.1),
mean = Prior_params_M2$mu_CQ_shape,
sd = Prior_params_M2$sigma_CQ_shape),
col='red',lwd=3)
# CQ_scale (Weibull scale parameter for CQ with or without PMQ)
hist(thetas_mod2$CQ_scale, xlim = c(35,55), freq = F, main='',
xlab= 'CQ scale parameter', yaxt='n', ylab='', col='grey', breaks=10)
lines(seq(30,70,by=1), dnorm(x = seq(30,70,by=1),
mean = Prior_params_M2$mu_CQ_scale,
sd = Prior_params_M2$sigma_CQ_scale),
col='red',lwd=3)
# Mean logit p (hierachical mean reinfection proportion)
hist(thetas_mod2$logit_mean_p, xlim = c(-4,-1), freq = F, main='',
xlab= 'Population logit p', yaxt='n', ylab='', col='grey', breaks=10)
lines(seq(-5,3,by=.01), dnorm(x = seq(-5,3,by=.01),
mean = Prior_params_M2$Hyper_logit_mean_p,
sd = Prior_params_M2$Hyper_logit_sd_p),
col='red',lwd=3)
# Mean logit p_PMQ (hierachical mean reinfection proportion after PMQ)
hist(thetas_mod2$logit_mean_p_PMQ, xlim = c(2,5), freq = F, main='',
xlab= 'Population logit p_PMQ', yaxt='n', ylab='', col='grey', breaks=10)
lines(seq(0,5,by=.01), dnorm(x = seq(0,5,by=.01),
mean = Prior_params_M2$Hyper_logit_mean_p_PMQ,
sd = Prior_params_M2$Hyper_logit_sd_p_PMQ),
col='red',lwd=3)
# Mean c1 AS (hierachical mean early relapse)
hist(thetas_mod2$logit_c1_AS, xlim = c(-5,-2), freq = F, main='',
xlab= 'Population logit c1: AS', yaxt='n', ylab='', col='grey', breaks=10)
lines(seq(-5,5,by=.01), dnorm(x = seq(-5,5,by=.01),
mean = Prior_params_M2$Hyper_logit_c1_mean,
sd = Prior_params_M2$Hyper_logit_c1_sd),
col='red',lwd=3)
# Mean c1: CQ (hierachical mean early relapse)
hist(thetas_mod2$logit_c1_CQ,  xlim = c(-5,-2), freq = F, main='',
xlab= 'Population logit c1: CQ', yaxt='n', ylab='', col='grey', breaks=10)
lines(seq(-5,5,by=.01), dnorm(x = seq(-5,5,by=.01),
mean = Prior_params_M2$Hyper_logit_c1_mean,
sd = Prior_params_M2$Hyper_logit_c1_sd),
col='red',lwd=3)
# Mean c1: CQ_PMQ (hierachical mean early relapse)
hist(thetas_mod2$logit_c1_CQ_PMQ,  xlim = c(-5,-2), freq = F, main='',
xlab= 'Population logit c1: PMQ+', yaxt='n', ylab='', col='grey', breaks=10)
lines(seq(-5,5,by=.01), dnorm(x = seq(-5,5,by=.01),
mean = Prior_params_M2$Hyper_logit_c1_mean,
sd = Prior_params_M2$Hyper_logit_c1_sd),
col='red',lwd=3)
# logit_EarlyL relapse
hist(thetas_mod2$logit_EarlyL, xlim = c(-1,1), freq = F, main='',
xlab= 'logit EarlyL', yaxt='n', ylab='', col='grey', breaks=10)
lines(seq(-1,5,by=.01), dnorm(x = seq(-1,5,by=.01),
mean = Prior_params_M2$Early_L_logit_mean,
sd = Prior_params_M2$Early_L_logit_sd),
col='red',lwd=3)
thetas_mod2 = extract(mod2_Fit)
K = 500000
Early_relapse = sample(x = inv.logit(thetas_mod2$logit_EarlyL),replace = T, size = K)
Mixture = sapply(Early_relapse, FUN = function(x){
sample(x = 1:2, replace = T, size = 1 , prob = c(x,1-x))
})
# Artesunate mono-therapy
T1s = rweibull(n = K, shape = sample(x = thetas_mod2$AS_shape, size = K, replace = T),
scale = sample(x = thetas_mod2$AS_scale, size = K, replace = T))
T2s = rexp(n = K, rate =  sample(x = 1/thetas_mod2$inv_gamma, size = K, replace = T))
Times_RelapseAS = c(T1s[Mixture==1], T2s[Mixture==2])
par(mfrow=c(1,2), las=1)
# Chloroquine mono-therapy
T1s = rweibull(n = K, shape = sample(x = thetas_mod2$CQ_shape, size = K, replace = T),
scale = sample(x = thetas_mod2$CQ_scale, size = K, replace = T))
T2s = rexp(n = K, rate =  sample(x = 1/thetas_mod2$inv_gamma, size = K, replace = T))
Times_RelapseCQ = c(T1s[Mixture==1], T2s[Mixture==2])
hist(Times_RelapseAS, breaks = seq(0,7000, by=7), xlim=c(0,100),
main='', col=drug_cols3['AS'], density = 15, yaxt='n',ylab = '',
xlab='Months after treatment', xaxt='n')
hist(Times_RelapseCQ, breaks = seq(0,7000, by=7), xlim=c(0,100),
main='', add=T, density=15, col=drug_cols3['CHQ'], angle= -30)
axis(1, at = seq(0,90, by=30), labels =  seq(0,90, by=30)/30)
legend('topright', col=drug_cols3[1:2], lwd=3,bty='n',
legend = c('Artesunate','Chloroquine'))
plot(ecdf(Times_RelapseAS[Times_RelapseAS<360]),
col=drug_cols3['AS'], xaxt='n',main='',
xlab='Months after treatment', bty='n', yaxt='n',
ylab = 'Relapses observed (%)', lwd=3, lty=1)
axis(2, at = c(0,.25,.5,.75,.9,1),
labels = 100*c(0,.25,.5,.75,.9,1))
axis(1, at = seq(0,360, by=60), labels =  seq(0,360, by=60)/30)
lines(ecdf(Times_RelapseCQ[Times_RelapseCQ<360]),
col=drug_cols3['CHQ'], lwd=3, lty=1)
axis(1, at = seq(0,360, by=60), labels =  seq(0,360, by=60)/30)
abline(h=.9, lwd=2, lty=2)
abline(v=4*30, lwd=2, lty=2)
Label_probability = function(drug,t, thetas){
# drug independent parameters
q = inv.logit(mean(thetas$logit_EarlyL))
if(drug == 'AS'){
p = inv.logit(mean(thetas$logit_p))
c = inv.logit(mean(thetas$logit_c1_AS))
p_relapse = (1-p) * (1-c) * (q * dexp(x = t, rate = 1/mean(thetas$inv_gamma)) +
(1-q) * dweibull(x = t,shape = mean(thetas$AS_shape),
scale = mean(thetas$AS_scale)))
p_recrudes = (1-p) * c * dweibull(x = t,shape = mean(thetas$Recrud_shape),
scale = mean(thetas$Recrud_scale))
p_reinfect = p * dexp(x = t,rate = 1/mean(thetas$inv_lambda))
}
if(drug == 'CHQ'){
p = inv.logit(mean(thetas$logit_p))
c = inv.logit(mean(thetas$logit_c1_CQ))
p_relapse = (1-p) * (1-c) * (q * dexp(x = t, rate = 1/mean(thetas$inv_gamma)) +
(1-q) * dweibull(x = t,shape = mean(thetas$CQ_shape),
scale = mean(thetas$CQ_scale)))
p_recrudes = (1-p) * c * dweibull(x = t,shape = mean(thetas$Recrud_shape),
scale = mean(thetas$Recrud_scale))
p_reinfect = p * dexp(x = t,rate = 1/mean(thetas$inv_lambda))
}
if(drug == 'PMQ+'){
p = inv.logit(mean(thetas$logit_p_PMQ))
c = inv.logit(mean(thetas$logit_c1_CQ_PMQ))
p_relapse = (1-p) * (1-c) * (q * dexp(x = t, rate = 1/mean(thetas$inv_gamma)) +
(1-q) * dweibull(x = t,shape = mean(thetas$CQ_shape),
scale = mean(thetas$CQ_scale)))
p_recrudes = (1-p) * c * dweibull(x = t,shape = mean(thetas$Recrud_shape),
scale = mean(thetas$Recrud_scale))
p_reinfect = p * dexp(x = t,rate = 1/mean(thetas$inv_lambda))
}
probs = data.frame(p_relapse=p_relapse,p_recrudes=p_recrudes,p_reinfect=p_reinfect)
for(i in 1:nrow(probs)){
probs[i,] = probs[i,]/sum(probs[i,])
}
return(probs)
}
layout(mat = matrix(data = c(1,1,2,2,1,1,2,2,3,3,4,5,3,3,4,5),byrow = T,nrow = 4))
par(las=1,bty='n', cex.lab=1.3, cex.axis=1.3, mar=c(4,4,2,1))
#****************************** Reinfection ******************************
labels = extract(mod2_Fit, 'prob_labels')$prob_labels
mean_labels_Reinfection = apply(labels[,ind_plotting,1,drop=T], 2, mean)
plot(Combined_Time_Data$Time_to_event[ind_plotting], log10(mean_labels_Reinfection),
col = drug_cols3[Combined_Time_Data$numeric_drug[ind_plotting]+1],
pch = 20,
cex=1,panel.first = grid(),
ylab='', yaxt='n',xaxt='n',
xlab='', xlim=c(0,360))
mtext(text = 'Probability of Reinfection',side = 2, las=3,line=3,cex=.8)
mtext(text = 'Months from last episode',side = 1,line=3,cex=1)
mtext(text='A', side = 3, adj = 0, line=0.5)
axis(1, at = seq(0, 360, by=60), labels = seq(0, 360, by=60)/30)
axis(2, at = -2:0, labels= 10^(-2:0))
axis(2, at = log10(seq(.1,1,by=.1)), labels = NA)
axis(2, at = log10(seq(.01,.1,by=.01)), labels = NA)
axis(2, at = log10(seq(.001,.01,by=.001)), labels = NA)
legend('bottomright',legend = c('Artesunate',
'Chloroquine',
'Primaquine+'),
col=drug_cols3,pch = 20, bty='o',lwd=2,bg='white',lty=NA, cex=1.35)
lines(Ts, log10(prob_labels_raw_AS[1,]), col=drug_cols3[1], lwd=2, lty=2)
# Now we compute the fixed effect probabilities over time
Ts = 1:360
# AS
prob_labels_raw_AS = array(dim = c(4,length(Ts)))
# Reinfection
prob_labels_raw_AS[1,] = exp(mean(thetas_mod2$log_p))*dexp(Ts, rate = 1/mean(thetas_mod2$inv_lambda));
# Early Relapse
prob_labels_raw_AS[2,] = exp(mean(thetas_mod2$log_1m_p))*exp(mean(thetas_mod2$log_1m_c1_AS))*exp(mean(thetas_mod2$log_EarlyL))*dweibull(Ts , shape = mean(thetas_mod2$AS_shape), scale = mean(thetas_mod2$AS_scale))
# Late Relapse
prob_labels_raw_AS[3,] = exp(mean(thetas_mod2$log_1m_p))*exp(mean(thetas_mod2$log_1m_c1_AS))*exp(mean(thetas_mod2$log_1m_EarlyL))*dexp(Ts, rate = 1/mean(thetas_mod2$inv_gamma))
# Recrudescence
prob_labels_raw_AS[4,] = exp(mean(thetas_mod2$log_1m_p))*exp(mean(thetas_mod2$log_c1_AS))*dweibull(Ts, shape =  mean(thetas_mod2$Recrud_shape), scale = mean(thetas_mod2$Recrud_scale))
# CQ
prob_labels_raw_CQ = array(dim = c(4,length(Ts)))
# Reinfection
prob_labels_raw_CQ[1,] = exp(mean(thetas_mod2$log_p))*dexp(Ts, rate = 1/mean(thetas_mod2$inv_lambda));
# Early Relapse
prob_labels_raw_CQ[2,] = exp(mean(thetas_mod2$log_1m_p))*exp(mean(thetas_mod2$log_1m_c1_CQ))*exp(mean(thetas_mod2$log_EarlyL))*dweibull(Ts , shape = mean(thetas_mod2$CQ_shape), scale = mean(thetas_mod2$CQ_scale))
# Late Relapse
prob_labels_raw_CQ[3,] = exp(mean(thetas_mod2$log_1m_p))*exp(mean(thetas_mod2$log_1m_c1_CQ))*exp(mean(thetas_mod2$log_1m_EarlyL))*dexp(Ts, rate = 1/mean(thetas_mod2$inv_gamma))
# Recrudescence
prob_labels_raw_CQ[4,] = exp(mean(thetas_mod2$log_1m_p))*exp(mean(thetas_mod2$log_c1_CQ))*dweibull(Ts, shape =  mean(thetas_mod2$Recrud_shape), scale = mean(thetas_mod2$Recrud_scale))
# CQ+PMQ
prob_labels_raw_CQPMQ = array(dim = c(4,length(Ts)))
# Reinfection
prob_labels_raw_CQPMQ[1,] = exp(mean(thetas_mod2$log_p_PMQ))*dexp(Ts, rate = 1/mean(thetas_mod2$inv_lambda));
# Early Relapse
prob_labels_raw_CQPMQ[2,] = exp(mean(thetas_mod2$log_1m_p_PMQ))*exp(mean(thetas_mod2$log_1m_c1_CQ_PMQ))*exp(mean(thetas_mod2$log_EarlyL))*dweibull(Ts , shape = mean(thetas_mod2$CQ_shape), scale = mean(thetas_mod2$CQ_scale))
# Late Relapse
prob_labels_raw_CQPMQ[3,] = exp(mean(thetas_mod2$log_1m_p_PMQ))*exp(mean(thetas_mod2$log_1m_c1_CQ_PMQ))*exp(mean(thetas_mod2$log_1m_EarlyL))*dexp(Ts, rate = 1/mean(thetas_mod2$inv_gamma))
# Recrudescence
prob_labels_raw_CQPMQ[4,] = exp(mean(thetas_mod2$log_1m_p_PMQ))*exp(mean(thetas_mod2$log_c1_CQ_PMQ))*dweibull(Ts, shape =  mean(thetas_mod2$Recrud_shape), scale = mean(thetas_mod2$Recrud_scale))
for(i in 1:length(Ts)){
prob_labels_raw_AS[,i] = prob_labels_raw_AS[,i]/sum(prob_labels_raw_AS[,i])
prob_labels_raw_CQ[,i] = prob_labels_raw_CQ[,i]/sum(prob_labels_raw_CQ[,i])
prob_labels_raw_CQPMQ[,i] = prob_labels_raw_CQPMQ[,i]/sum(prob_labels_raw_CQPMQ[,i])
}
layout(mat = matrix(data = c(1,1,2,2,1,1,2,2,3,3,4,5,3,3,4,5),byrow = T,nrow = 4))
par(las=1,bty='n', cex.lab=1.3, cex.axis=1.3, mar=c(4,4,2,1))
#****************************** Reinfection ******************************
labels = extract(mod2_Fit, 'prob_labels')$prob_labels
mean_labels_Reinfection = apply(labels[,ind_plotting,1,drop=T], 2, mean)
plot(Combined_Time_Data$Time_to_event[ind_plotting], log10(mean_labels_Reinfection),
col = drug_cols3[Combined_Time_Data$numeric_drug[ind_plotting]+1],
pch = 20,
cex=1,panel.first = grid(),
ylab='', yaxt='n',xaxt='n',
xlab='', xlim=c(0,360))
mtext(text = 'Probability of Reinfection',side = 2, las=3,line=3,cex=.8)
mtext(text = 'Months from last episode',side = 1,line=3,cex=1)
mtext(text='A', side = 3, adj = 0, line=0.5)
axis(1, at = seq(0, 360, by=60), labels = seq(0, 360, by=60)/30)
axis(2, at = -2:0, labels= 10^(-2:0))
axis(2, at = log10(seq(.1,1,by=.1)), labels = NA)
axis(2, at = log10(seq(.01,.1,by=.01)), labels = NA)
axis(2, at = log10(seq(.001,.01,by=.001)), labels = NA)
legend('bottomright',legend = c('Artesunate',
'Chloroquine',
'Primaquine+'),
col=drug_cols3,pch = 20, bty='o',lwd=2,bg='white',lty=NA, cex=1.35)
lines(Ts, log10(prob_labels_raw_AS[1,]), col=drug_cols3[1], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQ[1,]), col=drug_cols3[2], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQPMQ[1,]), col=drug_cols3[3], lwd=2, lty=2)
#****************************** Recrudescence ****************************
mean_labels_ReCrud = apply(labels[,ind_plotting,4,drop=T], 2, mean)
plot(Combined_Time_Data$Time_to_event[ind_plotting], (mean_labels_ReCrud),
col = drug_cols3[Combined_Time_Data$numeric_drug[ind_plotting]+1], xaxt='n',
pch = 20,
cex=1,panel.first = grid(),
ylab='Probability of Recrudescence',yaxt='n',
xlab='', xlim=c(0,12*30), ylim=c(0,1))
mtext(text='B', side = 3, adj = 0, line=0.5)
mtext(text = 'Months from last episode',side = 1,line=3,cex=1)
#axis(1, at = (0:6)*30, labels = 0:6)
#axis(2, at = log10(c(0.001,0.01,.1, .2)), labels = c(0.001,0.01,.1, .2))
#axis(2, at = log10(seq(.01,.1,by=.01)), labels = NA)
#axis(2, at = log10(seq(.001,.01,by=.001)), labels = NA)
lines(Ts, log10(prob_labels_raw_AS[4,]), col=drug_cols3[1], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQ[4,]), col=drug_cols3[2], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQPMQ[4,]), col=drug_cols3[3], lwd=2, lty=2)
#****************************** Relapse **********************************
mean_labels_ReLap1= apply(labels[,ind_plotting,2,drop=T], 2, mean)
mean_labels_ReLap2= apply(labels[,ind_plotting,3,drop=T], 2, mean)
mean_labels_ReLap = mean_labels_ReLap1 + mean_labels_ReLap2
plot(Combined_Time_Data$Time_to_event[ind_plotting], log10(mean_labels_ReLap),
col = drug_cols3[Combined_Time_Data$numeric_drug[ind_plotting]+1], xaxt='n',
pch = 20,#as.numeric(Combined_Time_Data$Censored[ind_plotting])+16,
cex=1,panel.first = grid(),
ylab='Probability of Relapse',yaxt='n',
xlab='', xlim=c(0,360))
mtext(text='C', side = 3, adj = 0, line=0.5)
axis(1, at = seq(0, 360, by=60), labels = seq(0, 360, by=60)/30)
axis(2, at = -2:0, labels= 10^(-2:0))
axis(2, at = log10(seq(.1,1,by=.1)), labels = NA)
axis(2, at = log10(seq(.01,.1,by=.01)), labels = NA)
axis(2, at = log10(seq(.001,.01,by=.001)), labels = NA)
mtext(text = 'Months from last episode',side = 1,line=3,cex=1)
lines(Ts, log10(prob_labels_raw_AS[2,]+prob_labels_raw_AS[3,]), col=drug_cols3[1], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQ[2,]+prob_labels_raw_CQ[3,]), col=drug_cols3[2], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQPMQ[2,]+prob_labels_raw_CQPMQ[3,]), col=drug_cols3[3], lwd=2, lty=2)
#****************************** Histograms of key model parameters ***********************
Recurrence_cols_PMQ = brewer.pal(4,'Greens')[2:4]
Recurrence_cols_noPMQ = brewer.pal(4,'Oranges')[2:4]
LinesTypes = c(1,3,4)
par(cex.lab=.7, cex.axis=.75)
t_points = seq(0,360,by=1)/30
PMQ_labels = Label_probability(drug = 'PMQ+',t = t_points*30, thetas = thetas_mod2)
plot(t_points, PMQ_labels[,1], lwd=3, type='l', ylim = c(0,1),
main = 'PMQ+', col=Recurrence_cols_PMQ[1],panel.first = grid(),
xlab='', ylab='Recurrence probability',yaxt='n',lty=LinesTypes[1])
lines(t_points, PMQ_labels[,2], lwd=3,col=Recurrence_cols_PMQ[2],lty=LinesTypes[2])
lines(t_points, PMQ_labels[,3], lwd=3,col=Recurrence_cols_PMQ[3],lty=LinesTypes[3])
mtext(text='D', side = 3, adj = 0, line=0.5)
mtext(text = 'Months from last episode',side = 1,line=3,cex=.7)
axis(2, at = c(0,.25,.5,.75,1))
# legend('right',legend = c('Relapse',
#                           'Recrudescence',
#                           'Reinfection'),
#        col=Recurrence_cols_PMQ,pch = NA, bty='o',
#        lwd=3,bg='white',lty=LinesTypes, cex=.8)
CQ_labels = Label_probability(drug = 'CHQ',t = t_points*30, thetas = thetas_mod2)
plot(t_points, CQ_labels[,1], lwd=3, type='l', ylim = c(0,1),
main = 'No PMQ', col=Recurrence_cols_noPMQ[1],xlab='',lty=LinesTypes[1],
panel.first = grid(), ylab = 'Recurrence probability',yaxt='n')
axis(2, at = c(0,.25,.5,.75,1))
lines(t_points, CQ_labels[,2], lwd=3,col=Recurrence_cols_noPMQ[2],lty=LinesTypes[2])
lines(t_points, CQ_labels[,3], lwd=3,col=Recurrence_cols_noPMQ[3],lty=LinesTypes[3])
mtext(text = 'Months from last episode',side = 1,line=3,cex=.7)
legend('right',legend = c('Relapse',
'Recrudescence',
'Reinfection'),
col='black',pch = NA, bty='o',
lwd=2,bg='white',lty=LinesTypes, cex=.7)
# indAS = ID_mapped_to_noPMQ_rank[Combined_Time_Data$ID[!duplicated(Combined_Time_Data$ID)&
#                                                         Combined_Time_Data$numeric_drug==0]]
# indCQ = ID_mapped_to_noPMQ_rank[Combined_Time_Data$ID[!duplicated(Combined_Time_Data$ID)&
#                                                         Combined_Time_Data$numeric_drug==1]]
# plot(density((1-inv.logit(apply(thetas_mod2$logit_p,2,mean)[indAS]))*(1-inv.logit(mean(thetas_mod2$logit_c1_AS)))),
#      xaxt='n',
#      xlab = '', main = '',
#      col = drug_cols3['AS'], lwd=3,
#      yaxt='n',ylab='', xlim=c(0,1))
# lines(density(1-inv.logit(apply(thetas_mod2$logit_p,2,mean)[indCQ])),
#       col = drug_cols3['CHQ'], lwd=3)
# mtext(text = 'Relapse: no PMQ',side = 1,line=3,cex=.8)
# axis(1, at=c(0,.5,1))
#
# plot(density(1-inv.logit(apply(thetas_mod2$logit_p_PMQ,2,mean))),
#      xlab = '', main = '', col=drug_cols3['CHQ/PMQ'],lwd=3,
#      yaxt='n',ylab='')
# mtext(text = 'Relapse: PMQ',side = 1,line=3,cex=.8)
#
# plot(density(inv.logit(mean(thetas_mod2$logit_c1_AS))*(1-inv.logit(apply(thetas_mod2$logit_p,2,mean)[indAS]))),
#      col = drug_cols3['AS'],lwd=3,xlim = c(0, 0.03),
#      xlab = '', main='',yaxt='n',ylab='')
# lines(density(inv.logit(mean(thetas_mod2$logit_c1_CQ))*(1-inv.logit(apply(thetas_mod2$logit_p,2,mean)[indCQ]))),
#       col = drug_cols3['CHQ'],lwd=3)
# #lines(density(inv.logit(mean(thetas_mod2$logit_c1_CQ_PMQ))*(1-inv.logit(apply(thetas_mod2$logit_p_PMQ,2,mean)))),
# #       col = drug_cols3['CHQ/PMQ'], lwd=3)
# mtext(text = 'Recrudescence',side = 1,line=3,cex=.8)
# plot(density(inv.logit(thetas_mod2$logit_EarlyL)), xlab = '',
#      main='',yaxt='n',ylab='', col = 'black', lwd=3)
# mtext(text = 'Early Relapse',side = 1,line=3,cex=.8)
layout(mat = matrix(data = c(1,1,2,2,1,1,2,2,3,3,4,5,3,3,4,5),byrow = T,nrow = 4))
par(las=1,bty='n', cex.lab=1.3, cex.axis=1.3, mar=c(4,4,2,1))
#****************************** Reinfection ******************************
labels = extract(mod2_Fit, 'prob_labels')$prob_labels
mean_labels_Reinfection = apply(labels[,ind_plotting,1,drop=T], 2, mean)
plot(Combined_Time_Data$Time_to_event[ind_plotting], log10(mean_labels_Reinfection),
col = drug_cols3[Combined_Time_Data$numeric_drug[ind_plotting]+1],
pch = 20,
cex=1,panel.first = grid(),
ylab='', yaxt='n',xaxt='n',
xlab='', xlim=c(0,360))
mtext(text = 'Probability of Reinfection',side = 2, las=3,line=3,cex=.8)
mtext(text = 'Months from last episode',side = 1,line=3,cex=1)
mtext(text='A', side = 3, adj = 0, line=0.5)
axis(1, at = seq(0, 360, by=60), labels = seq(0, 360, by=60)/30)
axis(2, at = -2:0, labels= 10^(-2:0))
axis(2, at = log10(seq(.1,1,by=.1)), labels = NA)
axis(2, at = log10(seq(.01,.1,by=.01)), labels = NA)
axis(2, at = log10(seq(.001,.01,by=.001)), labels = NA)
legend('bottomright',legend = c('Artesunate',
'Chloroquine',
'Primaquine+'),
col=drug_cols3,pch = 20, bty='o',lwd=2,bg='white',lty=NA, cex=1.35)
lines(Ts, log10(prob_labels_raw_AS[1,]), col=drug_cols3[1], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQ[1,]), col=drug_cols3[2], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQPMQ[1,]), col=drug_cols3[3], lwd=2, lty=2)
#****************************** Recrudescence ****************************
mean_labels_ReCrud = apply(labels[,ind_plotting,4,drop=T], 2, mean)
plot(Combined_Time_Data$Time_to_event[ind_plotting], log10(mean_labels_ReCrud),
col = drug_cols3[Combined_Time_Data$numeric_drug[ind_plotting]+1], xaxt='n',
pch = 20,
cex=1,panel.first = grid(),
ylab='Probability of Recrudescence',yaxt='n',
xlab='', xlim=c(0,12*30))
mtext(text='B', side = 3, adj = 0, line=0.5)
mtext(text = 'Months from last episode',side = 1,line=3,cex=1)
#axis(1, at = (0:6)*30, labels = 0:6)
#axis(2, at = log10(c(0.001,0.01,.1, .2)), labels = c(0.001,0.01,.1, .2))
#axis(2, at = log10(seq(.01,.1,by=.01)), labels = NA)
#axis(2, at = log10(seq(.001,.01,by=.001)), labels = NA)
lines(Ts, log10(prob_labels_raw_AS[4,]), col=drug_cols3[1], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQ[4,]), col=drug_cols3[2], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQPMQ[4,]), col=drug_cols3[3], lwd=2, lty=2)
#****************************** Relapse **********************************
mean_labels_ReLap1= apply(labels[,ind_plotting,2,drop=T], 2, mean)
mean_labels_ReLap2= apply(labels[,ind_plotting,3,drop=T], 2, mean)
mean_labels_ReLap = mean_labels_ReLap1 + mean_labels_ReLap2
plot(Combined_Time_Data$Time_to_event[ind_plotting], log10(mean_labels_ReLap),
col = drug_cols3[Combined_Time_Data$numeric_drug[ind_plotting]+1], xaxt='n',
pch = 20,#as.numeric(Combined_Time_Data$Censored[ind_plotting])+16,
cex=1,panel.first = grid(),
ylab='Probability of Relapse',yaxt='n',
xlab='', xlim=c(0,360))
mtext(text='C', side = 3, adj = 0, line=0.5)
axis(1, at = seq(0, 360, by=60), labels = seq(0, 360, by=60)/30)
axis(2, at = -2:0, labels= 10^(-2:0))
axis(2, at = log10(seq(.1,1,by=.1)), labels = NA)
axis(2, at = log10(seq(.01,.1,by=.01)), labels = NA)
axis(2, at = log10(seq(.001,.01,by=.001)), labels = NA)
mtext(text = 'Months from last episode',side = 1,line=3,cex=1)
lines(Ts, log10(prob_labels_raw_AS[2,]+prob_labels_raw_AS[3,]), col=drug_cols3[1], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQ[2,]+prob_labels_raw_CQ[3,]), col=drug_cols3[2], lwd=2, lty=2)
lines(Ts, log10(prob_labels_raw_CQPMQ[2,]+prob_labels_raw_CQPMQ[3,]), col=drug_cols3[3], lwd=2, lty=2)
#****************************** Histograms of key model parameters ***********************
Recurrence_cols_PMQ = brewer.pal(4,'Greens')[2:4]
Recurrence_cols_noPMQ = brewer.pal(4,'Oranges')[2:4]
LinesTypes = c(1,3,4)
par(cex.lab=.7, cex.axis=.75)
t_points = seq(0,360,by=1)/30
PMQ_labels = Label_probability(drug = 'PMQ+',t = t_points*30, thetas = thetas_mod2)
plot(t_points, PMQ_labels[,1], lwd=3, type='l', ylim = c(0,1),
main = 'PMQ+', col=Recurrence_cols_PMQ[1],panel.first = grid(),
xlab='', ylab='Recurrence probability',yaxt='n',lty=LinesTypes[1])
lines(t_points, PMQ_labels[,2], lwd=3,col=Recurrence_cols_PMQ[2],lty=LinesTypes[2])
lines(t_points, PMQ_labels[,3], lwd=3,col=Recurrence_cols_PMQ[3],lty=LinesTypes[3])
mtext(text='D', side = 3, adj = 0, line=0.5)
mtext(text = 'Months from last episode',side = 1,line=3,cex=.7)
axis(2, at = c(0,.25,.5,.75,1))
# legend('right',legend = c('Relapse',
#                           'Recrudescence',
#                           'Reinfection'),
#        col=Recurrence_cols_PMQ,pch = NA, bty='o',
#        lwd=3,bg='white',lty=LinesTypes, cex=.8)
CQ_labels = Label_probability(drug = 'CHQ',t = t_points*30, thetas = thetas_mod2)
plot(t_points, CQ_labels[,1], lwd=3, type='l', ylim = c(0,1),
main = 'No PMQ', col=Recurrence_cols_noPMQ[1],xlab='',lty=LinesTypes[1],
panel.first = grid(), ylab = 'Recurrence probability',yaxt='n')
axis(2, at = c(0,.25,.5,.75,1))
lines(t_points, CQ_labels[,2], lwd=3,col=Recurrence_cols_noPMQ[2],lty=LinesTypes[2])
lines(t_points, CQ_labels[,3], lwd=3,col=Recurrence_cols_noPMQ[3],lty=LinesTypes[3])
mtext(text = 'Months from last episode',side = 1,line=3,cex=.7)
legend('right',legend = c('Relapse',
'Recrudescence',
'Reinfection'),
col='black',pch = NA, bty='o',
lwd=2,bg='white',lty=LinesTypes, cex=.7)
# indAS = ID_mapped_to_noPMQ_rank[Combined_Time_Data$ID[!duplicated(Combined_Time_Data$ID)&
#                                                         Combined_Time_Data$numeric_drug==0]]
# indCQ = ID_mapped_to_noPMQ_rank[Combined_Time_Data$ID[!duplicated(Combined_Time_Data$ID)&
#                                                         Combined_Time_Data$numeric_drug==1]]
# plot(density((1-inv.logit(apply(thetas_mod2$logit_p,2,mean)[indAS]))*(1-inv.logit(mean(thetas_mod2$logit_c1_AS)))),
#      xaxt='n',
#      xlab = '', main = '',
#      col = drug_cols3['AS'], lwd=3,
#      yaxt='n',ylab='', xlim=c(0,1))
# lines(density(1-inv.logit(apply(thetas_mod2$logit_p,2,mean)[indCQ])),
#       col = drug_cols3['CHQ'], lwd=3)
# mtext(text = 'Relapse: no PMQ',side = 1,line=3,cex=.8)
# axis(1, at=c(0,.5,1))
#
# plot(density(1-inv.logit(apply(thetas_mod2$logit_p_PMQ,2,mean))),
#      xlab = '', main = '', col=drug_cols3['CHQ/PMQ'],lwd=3,
#      yaxt='n',ylab='')
# mtext(text = 'Relapse: PMQ',side = 1,line=3,cex=.8)
#
# plot(density(inv.logit(mean(thetas_mod2$logit_c1_AS))*(1-inv.logit(apply(thetas_mod2$logit_p,2,mean)[indAS]))),
#      col = drug_cols3['AS'],lwd=3,xlim = c(0, 0.03),
#      xlab = '', main='',yaxt='n',ylab='')
# lines(density(inv.logit(mean(thetas_mod2$logit_c1_CQ))*(1-inv.logit(apply(thetas_mod2$logit_p,2,mean)[indCQ]))),
#       col = drug_cols3['CHQ'],lwd=3)
# #lines(density(inv.logit(mean(thetas_mod2$logit_c1_CQ_PMQ))*(1-inv.logit(apply(thetas_mod2$logit_p_PMQ,2,mean)))),
# #       col = drug_cols3['CHQ/PMQ'], lwd=3)
# mtext(text = 'Recrudescence',side = 1,line=3,cex=.8)
# plot(density(inv.logit(thetas_mod2$logit_EarlyL)), xlab = '',
#      main='',yaxt='n',ylab='', col = 'black', lwd=3)
# mtext(text = 'Early Relapse',side = 1,line=3,cex=.8)
